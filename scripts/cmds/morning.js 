const fs = require("fs-extra");
const path = require("path");
const axios = require("axios");

let lastSentIndex = -1;

module.exports = {
  config: {
    name: "morning",
    version: "1.1",
    author: "Raj",
    countDown: 5,
    role: 0,
    shortDescription: "no-prefix",
    longDescription: "Good morning funny gif sender",
    category: "no prefix",
    guide: { en: "{p}{n}" }
  },

  onStart: async function () { },

  onChat: async function ({ api, event }) {
    const { threadID, messageID, body } = event;
    if (!body) return;
    const messageText = body.toLowerCase().trim();

    const triggers = [
      "good morning",
      "gud morning",
      "gm",
      "‡§∏‡•Å‡§¨‡§π ‡§¨‡§ñ‡•à‡§∞",
      "‡§∂‡•Å‡§≠ ‡§™‡•ç‡§∞‡§≠‡§æ‡§§"
    ];

    const replies = [
      "üåû ùêÜùê®ùê®ùêù ùêåùê®ùê´ùêßùê¢ùêßùê† üíõ\n‚òï ùêÇùê°ùêöùê¢ ùê©ùêûùêûùê•ùê® ùêöùêÆùê´ ùêùùê¢ùêß ùê§ùê¢ ùê¨ùê°ùêÆùê´ùêÆùêöùêöùê≠ ùê¶ùêöùê¨ùê≠ ùê§ùêöùê´ùê®!",
      "üåû ùêÜùê®ùê®ùêù ùêåùê®ùê´ùêßùê¢ùêßùê† üíõ\nüòÅ ùêìùêÆùê¶ùê°ùêöùê´ùê¢ ùê¨ùê¶ùê¢ùê•ùêû ùê¨ùêû ùê°ùê¢ ùêùùê¢ùêß ùêõùê´ùê¢ùê†ùê°ùê≠ ùê•ùêöùê†ùê≠ùêö ùê°ùêöùê¢!",
      "üåû ùêÜùê®ùê®ùêù ùêåùê®ùê´ùêßùê¢ùêßùê† üíõ\nüå∏ ùêÄùêöùê£ ùê§ùêö ùêùùê¢ùêß ùê≠ùêÆùê¶ùê°ùêöùê´ùêû ùê•ùê¢ùê≤ùêû ùê§ùê°ùêÆùê¨ùê°ùê¢ùê≤ùê®ùêß ùê¨ùêû ùêõùê°ùêöùê´ùêö ùê´ùêöùê°ùêû!",
      "üåû ùêÜùê®ùê®ùêù ùêåùê®ùê´ùêßùê¢ùêßùê† üíõ\n‚ú® ùêÉùê¢ùêß ùê§ùê¢ ùê¨ùê°ùêÆùê´ùêÆùêöùêöùê≠ ùê©ùê®ùê¨ùê¢ùê≠ùê¢ùêØùêû ùê¨ùê®ùêúùê°ùê®, ùê¨ùêöùêõ ùêöùêúùê°ùê°ùêö ùê°ùê®ùê†ùêö!"
    ];

    const mediaUrls = [
      "https://files.catbox.moe/7ucpbr.gif",
      "https://files.catbox.moe/kdn6y8.gif",
      "https://files.catbox.moe/9ndty1.gif"
    ];

    if (triggers.includes(messageText)) {
      let newIndex;
      do {
        newIndex = Math.floor(Math.random() * mediaUrls.length);
      } while (newIndex === lastSentIndex && mediaUrls.length > 1);
      lastSentIndex = newIndex;

      const selectedUrl = mediaUrls[newIndex];
      const cacheDir = path.join(__dirname, "cache");
      const filePath = path.join(cacheDir, "morning.gif");

      try {
        fs.ensureDirSync(cacheDir);

        const res = await axios({ url: selectedUrl, method: "GET", responseType: "stream" });
        const writer = fs.createWriteStream(filePath);
        res.data.pipe(writer);

        writer.on("finish", () => {
          const randomReply = replies[Math.floor(Math.random() * replies.length)];
          api.sendMessage({
            body: randomReply,
            attachment: fs.createReadStream(filePath)
          }, threadID, () => fs.unlinkSync(filePath));
        });

        writer.on("error", (err) => {
          console.error("Download Error:", err);
          api.sendMessage("‚ùå GIF laane me dikkat aayi!", threadID, messageID);
        });

      } catch (error) {
        console.error("Error:", error);
        api.sendMessage("‚ùå GIF laane me dikkat aayi!", threadID, messageID);
      }
    }
  }
};